<html>

<head>
	<title>Project 5</title>
	<script type='text/javascript' src='js/knockout-3.3.0.js'></script>
	<script type='text/javascript' src='js/jquery-2.1.3.min.js'></script>
	<link rel="stylesheet" type="text/css" href="css/main.css">
	<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBr9puVePcpzhyLxLfEph5-AXkvFtbxWe8">
	</script>

	<script type="text/javascript">

      $( document ).ready(  function(){

      	var map = new google.maps.Map(document.getElementById('map-canvas'), {center: new google.maps.LatLng(33.486305, -112.049339),zoom: 12 });
      
      	
		var markerInfo = [
			{   listText : "The Apple Store", 
				latLng : new google.maps.LatLng(33.5105393352139 , -112.028618823315 	), 
				title : "Apple Store", 
				infoText : 'the apple store bubble', 
				venueId : "4a3d9447f964a52077a21fe3"
			}, 
			{   listText :  "Los Reyes de la Torta" , 
				latLng : new google.maps.LatLng(33.57084159984521, -112.06561795215607), 
				title : "Los Reyes de la Torta", 
				infoText : 'Los Reyes de la Torta bubble', 
				venueId : "4b61dfacf964a52069282ae3"
			},
			{
				listText : "Green Restaurant",
				latLng : new google.maps.LatLng( 33.47016494688462,  -112.06533268014412 ),
				title : "Green Restaurant", 
				infoText : 'green bubble', 
				venueId : "4e8a0dc45c5c370ff4894f15"
			},
			{
				listText : "Copper Star Coffee",
				latLng : new google.maps.LatLng( 33.49749976025891, -112.08386364950333 ),
				title : "Copper Star Coffee", 
				infoText : 'Copper Star Bubble', 
				venueId : "4a57f364f964a52021b71fe3"
			},
			{
				listText : "Olive Garden",
				latLng : new google.maps.LatLng(  33.581339203011716,  -112.1181889383759),
				title : "Olive Garden", 
				infoText : 'Olive Garden Bubble', 
				venueId : "4b4e8298f964a5200ff026e3"
			}
		]
     
  

		var clientId = "BQGC5WNEA0R1OCNX5OS5K3Q0WLGQ5OSJQAICSYNCHQ5TULJN";
		var clientSecret = "HUOXP5ZINAHDEH2EHGZLM0ZH0E0XSZN3CYQMMBIP0MAVYXRP";


      	// 
      	// start of the knockout init code
      	//
      	function DecoratedMarker( marker_info, mvm ){
      		var self = this;

      		// this is the text displayed in the list view
      		self.info = marker_info["listText"];
      		self.mvm = mvm;
      		self.venueId = marker_info['venueId'];

      		self.bubbleText  = ko.observable( marker_info["infoText"])
      		//self.infowindow = new google.maps.InfoWindow( { content : marker_info["infoText"] })
      		self.infowindow = new google.maps.InfoWindow( { content : self.bubbleText() })

      		self.mapMarker = new google.maps.Marker({ position: marker_info["latLng"],map: map,title: marker_info["title"] }); 


      		// This function is called when one of the markers on the map is clicked
      		google.maps.event.addListener( self.mapMarker , 'click',  function(){  
      			self.selected();
      		}); 

      		// This function is called when one of the list items is clicked from list view
      		self.selected = function(){     
      			mvm.closeAll();
      			self.bubbleText('after the click')
      			self.infowindow.open( map,self.mapMarker );

      			$('#four-square-view').css( 'display', 'block');	
    
				var foursquareUrl = 'https://api.foursquare.com/v2/venues/' + self.venueId + '?v=20130815&' + 'client_id=' + clientId + '&client_secret=' + clientSecret;
			 
				 $.ajax( { url : foursquareUrl }).done( 			 	
						function ( response) { 
							var v = response.response.venue;
							mvm.fourName( v['name'])
			      			mvm.fourRating( v['rating'])
							//console.log( v['location'])
					});


      		}
      	}

      	function MarkerViewModel(){
      		var self = this;

      		var tmpArray = []
      		for( var i = 0; i < markerInfo.length; i++ ) tmpArray.push( new DecoratedMarker( markerInfo[i], self) );      
      		self.markers = ko.observableArray( tmpArray );

      		self.selectItem = function( item ){
      			item.selected();
      		}

      		self.closeAll = function( ){
      			for( var i = 0; i < self.markers().length; i++ ) self.markers()[i].infowindow.close();
      		}

      		self.fourName = ko.observable('inital');
      		self.fourRating = ko.observable( 'initial');
      	}
      	
        ko.applyBindings( new MarkerViewModel() );

      });

    </script>
</head>
<body>
		<table>
			<tr>
				<td><h1>Udacity Nanodegree Project 5</h1></td>
			</tr>
			<tr>
				<td>
			
					<form action="">
						<button type="button">Search</button>
						<input id="query"/>
					</form>
				</td>
			</tr>
		</table>	

	<div id="map-canvas"></div>

	<div id="list-view">
		<table>
			<tbody data-bind="foreach: markers()">
				<tr data-bind="click: $root.selectItem"><td data-bind="text: info"></td></tr>
			</tbody>
		</table>
	</div>

	<div id="four-square-view">
		FourSquare.com says ... <strong data-bind="text: fourName"></strong> is rated at <strong data-bind="text: fourRating"></strong></strong>
	</div>


</body>
</html>