<html>

<head>
	<title>Project 5</title>
	<script type='text/javascript' src='js/knockout-3.3.0.js'></script>
	<script type='text/javascript' src='js/jquery-2.1.3.min.js'></script>
	<link rel="stylesheet" type="text/css" href="css/main.css">
	<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBr9puVePcpzhyLxLfEph5-AXkvFtbxWe8">
	</script>

	<script type="text/javascript">

      $( document ).ready(  function(){

      	var map = new google.maps.Map(document.getElementById('map-canvas'), {center: new google.maps.LatLng(33.486305, -112.049339),zoom: 12 });
      
      	
		var markerInfo = [
			{   
				latLng : new google.maps.LatLng(33.5105393352139 , -112.028618823315 	), 
				title : "Apple Store", 
				infoText : 'The Apple Store sells macs and mac stuff.', 
				venueId : "4a3d9447f964a52077a21fe3",
				keys : [ 'computer', 'apple', 'biltmore']
			}, 
			{   
				latLng : new google.maps.LatLng(33.57084159984521, -112.06561795215607), 
				title : "Los Reyes de la Torta", 
				infoText : 'Mexico City style sandwich shop.', 
				venueId : "4b61dfacf964a52069282ae3", 
				keys : [ 'mexican', 'food']
			},
			{
				
				latLng : new google.maps.LatLng( 33.47016494688462,  -112.06533268014412 ),
				title : "Green Restaurant", 
				infoText : 'Vegan Food.', 
				venueId : "4e8a0dc45c5c370ff4894f15",
				keys : [ 'vegan', 'food']
			},
			{
				
				latLng : new google.maps.LatLng( 33.49749976025891, -112.08386364950333 ),
				title : "Copper Star Coffee", 
				infoText : 'local coffee shop.', 
				venueId : "4a57f364f964a52021b71fe3", 
				keys : [ 'coffee']
			},
			{
				
				latLng : new google.maps.LatLng(  33.581339203011716,  -112.1181889383759),
				title : "Olive Garden", 
				infoText : 'National Chain Restaurant.', 
				venueId : "4b4e8298f964a5200ff026e3", 
				keys : [ 'italian', 'food']
			}
		]
     
  

		var clientId = "BQGC5WNEA0R1OCNX5OS5K3Q0WLGQ5OSJQAICSYNCHQ5TULJN";
		var clientSecret = "HUOXP5ZINAHDEH2EHGZLM0ZH0E0XSZN3CYQMMBIP0MAVYXRP";


      	// 
      	// start of the knockout init code
      	//
      	function DecoratedMarker( marker_info, mvm ){
      		var self = this;

      		self.showIt = ko.observable( true )
      		self.mvm = mvm;
      		self.title = marker_info['title']
      		self.venueId = marker_info['venueId'];

      		self.isSelected = ko.observable( false );

			self.bubbleText  = ko.observable( marker_info["infoText"])

      		self.keys = marker_info['keys']
      		// take the bubbe text and the title and split them into words and add them to the list of keys
      		// so that the search will include that text as well
      		var bubbleParts = self.bubbleText().split( " ");
      		for( var i = 0 ; i < bubbleParts.length; i++ ) self.keys.push( bubbleParts[i] )
      			

      		// to do
      		//var titleParts = self.








      		self.infowindow = new google.maps.InfoWindow( { content : self.bubbleText() })

      		self.mapMarker = new google.maps.Marker({ position: marker_info["latLng"],map: map,title: marker_info["title"] }); 


      		// This function is called when one of the markers on the map is clicked
      		google.maps.event.addListener( self.mapMarker , 'click',  function(){  
      			self.selected();
      		}); 

      		// This function is called when one of the list items is clicked from list view
      		self.selected = function(){     
      			mvm.closeAll();
      			self.isSelected( true )
      			self.infowindow.open( map,self.mapMarker );

      			$('#four-square-view').css( 'display', 'block');	
				var foursquareUrl = 'https://api.foursquare.com/v2/venues/' + self.venueId + '?v=20130815&' + 'client_id=' + clientId + '&client_secret=' + clientSecret;
			 
				 $.ajax( { url : foursquareUrl }).done( 			 	
						function ( response) { 
							var v = response.response.venue;
							mvm.fourName( v['name'])
			      			mvm.fourRating( v['rating'])
					});
      		}

      		self.showBubble = function(){
				self.infowindow.open( map,self.mapMarker );
      		}

      		self.matches = function( q ){
      			// see if query 'q' appears in the keys
      			return $.inArray( q, self.keys ) != -1
      		}

      		// this is called from the search function to hide markers that do not match the search results
      		self.hide = function(){
      			self.infowindow.close()
      			self.mapMarker.setVisible( false );
      			self.showIt( false );
      			self.isSelected( false );
      			
      		}

      		self.show = function() {
      			self.mapMarker.setVisible( true );
      			self.showIt( true );
      			self.isSelected( true );
      			
      		}

      		self.showForSearchResults = function(){
      			self.show();
      			self.showBubble();
      		}
      		
      	}

      	function MarkerViewModel(){
      		var self = this;

      		var tmpArray = []
      		for( var i = 0; i < markerInfo.length; i++ ) tmpArray.push( new DecoratedMarker( markerInfo[i], self) );      
      		self.markers = ko.observableArray( tmpArray );

      		self.selectItem = function( item ){
      			item.selected();
      		}


      		self.closeAll = function( ){
      			for( var i = 0; i < self.markers().length; i++ ){
      				self.markers()[i].infowindow.close();
      				self.markers()[i].isSelected( false );	
      			} 
      		}

      		self.fourName = ko.observable('inital');
      		self.fourRating = ko.observable( 'initial');

      		self.searchQ = ko.observable( '' )
      		self.searchMarkers = function(){
      			self.hideAll();
      			var q = self.searchQ()

      			// find a list of markers that match this string
      			var filterList = []
      			for( var i = 0; i < self.markers().length; i++ ){
      				var m = self.markers()[i];
      				if( m.matches( q ))
      					filterList.push( m );
      			}

      			for( var i = 0; i < filterList.length; i++ ) {
      				filterList[i].showForSearchResults();
      			}

      		}

      		self.showAll = function(){ 
      			for( var i = 0; i < self.markers().length; i++ ){
					 self.markers()[i].show();  					 
				}
      		}


      		self.hideAll = function(){ 
      			for( var i = 0; i < self.markers().length; i++ ){
      				self.markers()[i].hide();	
      				self.markers()[i].isSelected(false)
      			}  
      		}

      		self.clearSearch = function(){
      			self.searchQ("")
      			self.hideAll()
      			self.showAll()
      		}
      	}
      	
        ko.applyBindings( new MarkerViewModel() );

      });

    </script>
</head>
<body>
		<table>
			<tr>
				<td><h1>Udacity Nanodegree Project 5</h1></td>
			</tr>
			<tr>
				<td>
						<button data-bind="click: searchMarkers">Search</button>						
						<input data-bind="value: searchQ" />
						<button data-bind="click: clearSearch">Clear</button>						
				</td>
			</tr>
		</table>	

	<div id="map-canvas"></div>

	<div id="list-view">
		<table>
			<tbody data-bind="foreach: markers()">
				<!-- <div data-bind="css: { profitWarning: currentProfit() < 0 }"> -->
				<tr data-bind="click: $root.selectItem, visible : showIt"><td data-bind="text: title, css : { selected : isSelected() }"></td></tr>
			</tbody>
		</table>
	</div>

	<div id="four-square-view">
		FourSquare.com says ... <strong data-bind="text: fourName"></strong> is rated at <strong data-bind="text: fourRating"></strong></strong>
	</div>


</body>
</html>